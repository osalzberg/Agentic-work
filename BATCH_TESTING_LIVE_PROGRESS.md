# Batch Testing: Live Progress Feed

## Overview
The batch testing feature now includes **real-time progress updates** showing each prompt being processed with immediate visual feedback. The Excel output includes **5 columns**:

1. **Prompt** - The natural language question
2. **Expected Query** - User can fill this manually for validation
3. **Generated Query** - KQL query generated by the AI
4. **Reason** - Error message if generation failed
5. **Query Output** - Execution results (row count, columns, or error)

## How It Works

### Architecture Change
**Before (Server-Side Batch):**
- Upload entire Excel file → Server processes all rows → Download results
- No visibility until complete
- Slow for large files (283 rows = several minutes)

**After (Client-Side Row-by-Row):**
1. Upload Excel file to `/api/batch-test/parse` → Extract prompts
2. **For each prompt:** 
   - Call `/api/query` to generate KQL
   - Call `/api/query-execute` to run the KQL and capture results
3. **Live updates:** Show each result instantly in the UI feed
4. Build final Excel via `/api/batch-test/build` with all results (including query output)

### New API Endpoints

#### `/api/query-execute` (POST)
**Purpose:** Execute a KQL query and return results
**Input:** `{ query: 'KQL query string' }`
**Output:** `{ success: true, tables: [{name, columns, rows, row_count}] }`

#### `/api/batch-test/parse` (POST)
**Purpose:** Parse Excel file and extract prompts without processing
**Input:** Excel file with "Prompt" column
**Output:** `{ success: true, prompts: ['prompt1', 'prompt2', ...] }`

#### `/api/batch-test/build` (POST)
**Purpose:** Build final Excel file from results
**Input:** `{ filename: 'test.xlsx', results: [{row, prompt, status, query, reason, output}, ...] }`
**Output:** `{ success: true, file_data: '<base64>', filename: 'results_test.xlsx' }`

### UI Features

#### 1. Live Results Feed
Located below the progress bar during processing:
```
┌─────────────────────────────────────┐
│  Live Results Feed                  │
├─────────────────────────────────────┤
│ ⏳ Row 15 - Processing...           │
│    Show me all failed requests      │
│                                     │
│ ✅ Row 14                           │
│    List top 10 slowest requests     │
│    Query generated (234 chars)      │
│                                     │
│ ❌ Row 13                           │
│    Show dependencies over time      │
│    No table matches found           │
└─────────────────────────────────────┘
```

**Status Icons:**
- ⏳ Processing... (blue)
- ✅ Success (green)
- ❌ Error (red)
- ⏭️ Skipped (gray)

#### 2. Progress Bar Updates
Shows current progress: `Processing 15 of 283: Show me all failed requests...`

#### 3. Auto-Scroll
Feed automatically scrolls to show the **latest** result at the top

## Benefits

### For Users
1. **Real-time visibility**: See which prompts are being processed
2. **Early error detection**: Identify problematic prompts immediately
3. **Progress confidence**: Know exactly where you are in the process
4. **Debugging**: See which specific prompts fail and why in real-time

### For Developers
1. **Better UX**: Users don't feel like the app is frozen
2. **Fault tolerance**: If browser crashes, partial progress is saved
3. **Rate limiting aware**: Can add delays between API calls if needed
4. **Easier debugging**: Console logs show each request/response

## Processing Flow

```
User Action: Select Excel + Click "Process"
      ↓
Parse Excel File (5%)
      ↓
Extract 283 prompts (10%)
      ↓
┌─────────────────────────────────────┐
│ For each prompt (10-95%):           │
│                                     │
│  1. Show "⏳ Processing..." in feed │
│  2. Call /api/query (generate KQL) │
│  3. Call /api/query-execute (run)  │
│  4. Update feed with result         │
│  5. Update progress bar             │
│                                     │
└─────────────────────────────────────┘
      ↓
Build Final Excel (95%)
      ↓
Show Summary + Download Button (100%)
```

## Code Changes

### Frontend (templates/index.html)

#### New Functions:
```javascript
// Add processing result to live feed
addLiveResult(rowNum, prompt, status, message)

// Update existing result with final status
updateLiveResult(rowNum, status, message)

// HTML escape helper for security
escapeHtml(text)
```

#### Modified Function:
```javascript
processBatchFile() {
  // OLD: Upload file, wait for all results
  // NEW: Parse → Loop → Process each → Execute → Build Excel
  
  for (let i = 0; i < prompts.length; i++) {
    addLiveResult(i+1, prompt, 'processing', '');
    // Call /api/query to generate KQL
    // Call /api/query-execute to run query
    updateLiveResult(i+1, 'success', queryResult);
  }
}
```

### Backend (web_app.py)

#### New Endpoints:
```python
@app.route('/api/query-execute', methods=['POST'])
def query_execute():
    # Execute KQL query → Return tables with row counts/columns

@app.route('/api/batch-test/parse', methods=['POST'])
def batch_test_parse():
    # Parse Excel → Return prompts array
    
@app.route('/api/batch-test/build', methods=['POST'])
def batch_test_build():
    # Receive results (with output) → Build Excel → Return base64
```

#### Unchanged:
- `/api/batch-test/upload` - Still exists for backward compatibility
- `/api/query` - Used for generating KQL from natural language
- `/api/query-execute` - New endpoint for executing generated KQL

## Performance Considerations

### Sequential Processing
- Processes **one prompt at a time** to avoid rate limiting
- Each prompt: Generate KQL (~1s) + Execute query (~1s) = **~2s per prompt**
- Total time: ~283 prompts × ~2s/prompt = **~9 minutes**
- User sees progress throughout instead of waiting blindly

### Optimization Opportunities
1. **Parallel batches**: Process 5-10 prompts simultaneously
2. **Caching**: Skip duplicate prompts
3. **Resume capability**: Save checkpoint, resume from failure
4. **Abort button**: Let user cancel mid-processing

## Error Handling

### Frontend
- Network errors show in live feed with red ❌
- Empty prompts automatically skipped with ⏭️
- Progress continues even if some rows fail

### Backend
- `/api/batch-test/parse` validates Excel structure
- `/api/batch-test/build` handles missing results gracefully
- Individual `/api/query` calls wrapped in try-catch

## Testing

### Manual Test Scenario
1. Create test Excel with 10 prompts (mix of valid/invalid)
2. Upload and click "Process Batch"
3. Verify live feed shows:
   - Row 1 processing → success
   - Row 2 processing → error (if invalid)
   - Row 3 processing → skipped (if empty)
4. Check final Excel has all results in correct columns
5. Verify download works

### Edge Cases Handled
- Empty prompts → Skip with reason
- Network timeout → Show error in feed
- Browser refresh → User needs to restart (future: save progress)
- Large files (1000+ rows) → May take time but shows progress

## Future Enhancements

1. **Pause/Resume**: Button to stop/continue processing
2. **Parallel Processing**: Process multiple prompts simultaneously
3. **Progress Persistence**: Save to localStorage, resume on reload
4. **Export Live Feed**: Download logs as separate file
5. **Filtering**: Show only errors/successes in feed
6. **Search**: Find specific prompts in feed
7. **WebSocket**: True streaming without polling

## Conclusion

The live progress feed transforms batch testing from a black-box operation into a transparent, real-time experience. Users can now:
- Monitor progress continuously
- Identify issues immediately
- Understand processing behavior
- Feel confident the system is working

This is especially valuable for large batches (100+ rows) where the previous approach felt unresponsive and error-prone.
